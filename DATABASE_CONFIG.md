# 数据库连接池配置说明

## 概述

为了适应 Supabase 的连接限制（15个连接），我们对数据库连接池进行了优化配置。

## 环境变量配置

### DB_POOL_MAX_SIZE
- **描述**: 数据库连接池最大连接数
- **默认值**: 12
- **推荐值**: 8-12（为 Supabase 预留缓冲）
- **示例**: `DB_POOL_MAX_SIZE=10`

### BATCH_MAX_CONCURRENCY
- **描述**: 批处理最大并发数
- **默认值**: 3
- **推荐值**: 2-4（避免过多并发连接）
- **示例**: `BATCH_MAX_CONCURRENCY=3`

### AFF_MAX_CONCURRENCY
- **描述**: 机构信息处理最大并发数
- **默认值**: 5
- **推荐值**: 3-5
- **示例**: `AFF_MAX_CONCURRENCY=4`

### ORCID_MAX_CONCURRENCY
- **描述**: ORCID 处理最大并发数
- **默认值**: 3
- **推荐值**: 2-3
- **示例**: `ORCID_MAX_CONCURRENCY=2`

## 连接池监控

系统现在会自动记录连接池使用情况：

- 初始化时记录连接池配置
- 批处理开始和结束时记录连接池状态
- 关闭时记录最终统计信息

## 最佳实践

1. **连接池大小**: 保持在 Supabase 限制的 80% 以下（推荐 8-12）
2. **并发控制**: 合理设置各类操作的并发数，避免连接池耗尽
3. **监控日志**: 定期检查连接池使用情况，及时发现问题
4. **错误处理**: 实现连接重试机制，处理连接断开情况

## 故障排除

如果遇到连接断开问题：

1. 检查连接池配置是否合理
2. 查看日志中的连接池统计信息
3. 适当降低并发数
4. 确保及时释放连接